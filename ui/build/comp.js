var exports = {}; "use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj};var Dropdown=React.createClass({displayName:"Dropdown",getInitialState:function getInitialState(){return{isOpen:"no"}},componentWillReceiveProps:function componentWillReceiveProps(nextProps){if(nextProps.isOpen){this.setState({isOpen:"opening"})}},componentDidMount:function componentDidMount(){document.addEventListener("click",this.documentClickHandler);document.addEventListener("keydown",this.handleKeyDown)},componentWillUnmount:function componentWillUnmount(){document.removeEventListener("click",this.documentClickHandler);document.removeEventListener("keydown",this.handleKeyDown)},handleKeyDown:function handleKeyDown(event){if(event.keyCode==13||event.keyCode==27){this.close()}},documentClickHandler:function documentClickHandler(){if(this.state.isOpen=="opening"){this.setState({isOpen:"open"})}else if(this.state.isOpen=="open"){this.close()}},dropdownClickHandler:function dropdownClickHandler(e){},close:function close(){this.setState({isOpen:"no"});if(this.props.onVisibilityChanged){this.props.onVisibilityChanged(false)}},render:function render(){return this.state.isOpen=="no"?null:React.createElement("div",{className:"dropdown-menu right visible",onClick:this.dropdownClickHandler,onKeyDown:this.handleKeyDown},this.props.children)}});exports.Dropdown=Dropdown;var EditableText=React.createClass({displayName:"EditableText",render:function render(){var name=this.props.name;if(name!=null){var lockState=this.props.editMode?"save":"edit";var style=this.props.editMode?"editable-text edit size":"editable-text size";var size=Math.min(Math.max(name.length,10),100);return React.createElement("span",null,React.createElement("input",{type:"text",size:size,className:style,disabled:!this.props.editMode,placeholder:this.props.placeholder,value:name,onChange:this.props.onChange}),React.createElement("button",{className:"action2Btn",onClick:this.props.onEdit},React.createElement("i",{className:"fa fa-"+lockState+" fa-lg"})))}else{return null}}});exports.EditableText=EditableText;var EntityPath=React.createClass({displayName:"EntityPath",browse:function browse(ancestor,className){if(this.props.onClick&&className=="active"){this.props.onClick(ancestor)}},render:function render(){var entity=this.props.data;var base=this.props.base;var enableLinks=base==null;if(entity!=null){var path=[];var ancestors=entity.execute("listAncestors").toArray();while(ancestors.length){var ancestor=ancestors.pop();if(ancestor==base){enableLinks=true}var ancestorName=ancestor.execute("getName")||React.createElement("i",null,"< ",ancestor.id," >");var className="el";if(ancestors.length){if(this.props.type=="parents"&&enableLinks){className="active"}else{className="el"}}else{if(this.props.type=="parents"){className="el"}else{className="active"}}path.push(React.createElement("span",{className:className,key:ancestor.id,onClick:this.browse.bind(this,ancestor,className)},React.createElement("span",{className:"slash"},"/"),ancestorName))}return React.createElement("span",{className:"path"},path)}else{return null}}});exports.EntityPath=EntityPath;var ListManager=React.createClass({displayName:"ListManager",render:function render(){var content=this.props.children.length?this.props.children:React.createElement("span",null,"This entity has no ",this.props.title,".Click bellow to add one.");return React.createElement("div",{className:"list-manager"},React.createElement("div",{className:"head"},React.createElement("div",{className:"title"},this.props.title)),React.createElement("ul",{className:"list"},content),React.createElement("div",{className:"footer"},React.createElement("div",{className:"content"},"Add ",this.props.name)))}});exports.default=ListManager;var MenuSelector=React.createClass({displayName:"MenuSelector",select:function select(selected){if(this.props.onSelect){this.props.onSelect(selected)}},render:function render(){var menuTitle=React.createElement("span",null,this.props.data.title,": ");var selected=this.props.data.selected;var menuItems=[];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.props.data.list.keys()[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var k=_step.value;var v=this.props.data.list.get(k);var className="";if(k==selected){className+=" selected"}if(this.props.type){className+=" "+this.props.type}var content=v.name;if(v.iconClass){content=React.createElement("i",{className:v.iconClass})}menuItems.push(React.createElement("span",{key:k,className:"menu-item"+className,onClick:this.select.bind(this,k),title:v.name},content))}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}return React.createElement("div",{className:"",onClick:this.dropdownClickHandler},menuTitle,React.createElement("span",null,menuItems))}});exports.MenuSelector=MenuSelector;var ModalDialog=React.createClass({displayName:"ModalDialog",handleClose:function handleClose(){if(this.props.onClose){this.props.onClose()}},handleKeyDown:function handleKeyDown(event){if(event.keyCode==13||event.keyCode==27){this.handleClose()}},render:function render(){return React.createElement("div",{className:"modal",onKeyDown:this.handleKeyDown},">",React.createElement("div",{className:"modal-content"},React.createElement("i",{className:"fa fa-close close",onClick:this.handleClose}),this.props.children))}});exports.ModalDialog=ModalDialog;var API="/api/entities";var _results={};var _changeListeners=[];var ServiceApi={init:function init(){window.builtInBlocks=new exports.BuiltInBlocks;window.builtInBlocks.init();window.entity=window.builtInBlocks.types.entity},searchEntities2:function searchEntities2(term,type,sort,arrange,page){var newFinder=window.builtInBlocks.types.newFinder;newFinder.execute("setFilter",{term:term,parent:type});newFinder.execute("setSort",{field:sort});newFinder.execute("clearFacets");var results=window.builtInBlocks.root.execute("listAllSubTypes",newFinder);var facets=newFinder.execute("listFacets");return{originalSearch:{term:term,type:type,sort:sort},count:results.size,entities:results,facets:facets}},getEntity2:function getEntity2(id){var results=window.builtInBlocks.root.execute("get",id);return results},unmarshallEntity:function unmarshallEntity(entityJson){return window.entity.execute("setJSON",entityJson)},unmarshallOldEntity:function unmarshallOldEntity(entityJson){return window.entity.execute("setJSON",entityJson)},resolveBehaviors:function resolveBehaviors(behaviors,callback){var result={};var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=behaviors[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var b=_step2.value;var bClass=window[b];if(bClass){result[b]=bClass}else{result[b]=null;console.error("Could not resolve: "+b)}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}callback(result)},searchType:function searchType(type,callback){var httpParams=ServiceApi.buildParams({"term":"*","type":type,"sort":"createDate","arrange":false,"page":"*"});var self=this;getJSON(API+httpParams,function(err,res){var entities=[];var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=res.entities[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var e=_step3.value;entities.push(self.unmarshallEntity(e))}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}var result={entities:entities,count:res.count,pages:res.pages,originalSearch:res.originalSearch,facets:res.facets};if(callback){callback(result)}})},searchEntities:function searchEntities(term,type,sort,arrange,page){var httpParams=ServiceApi.buildParams({"term":term,"type":type,"sort":sort,"arrange":arrange,"page":page});var self=this;getJSON(API+httpParams,function(err,res){var entities=[];var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=res.entities[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var e=_step4.value;entities.push(self.unmarshallEntity(e))}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}var result={entities:entities,count:res.count,pages:res.pages,originalSearch:res.originalSearch,facets:res.facets};_results=result;ServiceApi.notifyChange()})},addEntity:function addEntity(entity,cb){postJSON(API,entity,function(res){if(cb)cb(res)})},removeEntity:function removeEntity(id,cb){deleteJSON(API+"/"+id,cb)},getCachedEntities:function getCachedEntities(){return _results},getEntity:function getEntity(id,cb){var self=this;getJSON(API+"/"+id,function(err,res){var entity=self.unmarshallOldEntity(res);if(cb)cb(entity)})},getEntities:function getEntities(ids,cb){var self=this;getJSON(API+"/["+ids.toString()+"]",function(err,res){var entityList=[];var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=res[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var r=_step5.value;entityList.push(self.unmarshallOldEntity(r))}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}if(cb)cb(entityList)})},getComponents:function getComponents(comps,cb){var count=0;for(var key in comps){count++;var url=comps[key].url;util.loadJsComponent(url,key,function(res,key){comps[key].component=res;count--;if(cb&&count==0)cb(comps)})}},notifyChange:function notifyChange(){_changeListeners.forEach(function(listener){listener()})},addChangeListener:function addChangeListener(listener){_changeListeners.push(listener)},removeChangeListener:function removeChangeListener(listener){_changeListeners=_changeListeners.filter(function(l){return listener!==l})},buildParams:function buildParams(params){var httpParams="";for(var k in params){var v=params[k];if(v){if(httpParams==""){httpParams+="?"}httpParams+=k+"="+v+"&"}}return httpParams}};localStorage.token=localStorage.token||Date.now()*Math.random();function getJSON(url,cb){var req=new XMLHttpRequest;req.onload=function(){if(req.status===404){cb(new Error("not found"))}else{cb(null,JSON.parse(req.response))}};req.open("GET",url);req.setRequestHeader("authorization",localStorage.token);req.send()}function postJSON(url,obj,cb){var req=new XMLHttpRequest;req.onload=function(){cb(JSON.parse(req.response))};req.open("POST",url);req.setRequestHeader("Content-Type","application/json;charset=UTF-8");req.setRequestHeader("authorization",localStorage.token);req.send(JSON.stringify(obj))}function deleteJSON(url,cb){var req=new XMLHttpRequest;req.onload=cb;req.open("DELETE",url);req.setRequestHeader("authorization",localStorage.token);req.send()}exports.ServiceApi=ServiceApi;var Tabs=React.createClass({displayName:"Tabs",propTypes:{selected:React.PropTypes.number,children:React.PropTypes.oneOfType([React.PropTypes.array,React.PropTypes.element]).isRequired},getInitialState:function getInitialState(){return{selected:this.props.selected||0,isMoreDropdownOpen:false,isSettingsDropdownOpen:false,more:[]}},componentDidMount:function componentDidMount(){this.handleResize();window.addEventListener("resize",this.handleResize)},componentDidUpdate:function componentDidUpdate(){this.handleResize()},componentWillUnmount:function componentWillUnmount(){window.removeEventListener("resize",this.handleResize)},componentWillReceiveProps:function componentWillReceiveProps(nextProps){if(nextProps.selected!=null&&nextProps.selected!=this.state.selected){this.setState({selected:nextProps.selected})}},handleResize:function handleResize(){var more=[];var thisElem=ReactDOM.findDOMNode(this);var moreEl=thisElem.children[0].children[1];var moreWidth=moreEl.offsetWidth;var tabsElems=thisElem.children[0].children[2];if(tabsElems.children.length==1){moreEl.style.visibility="hidden";return}var settingsEl=thisElem.children[0].children[0];var settingsPos=settingsEl.offsetLeft;for(var i=0;i<tabsElems.children.length;i++){var tabEl=tabsElems.children[i];if(!tabEl){break}var pos=tabEl.offsetLeft;var width=tabEl.offsetWidth;if(pos+width+moreWidth>settingsPos){more.push(tabEl.textContent);tabEl.style.visibility="hidden"}else{tabEl.style.visibility=""}}if(more.length!=this.state.moreSize){moreEl.style.visibility=more.length>0?"":"hidden";var moreItems=[];for(var i in more){var m=more[i];moreItems.push(React.createElement("li",{className:"item",key:m},m))}this.setState({"more":React.createElement("div",{className:"list-manager"},React.createElement("ul",{className:"list"},moreItems)),moreSize:moreItems.length,isMoreDropdownOpen:false,isSettingsDropdownOpen:false})}},handleClick:function handleClick(index,event){event.preventDefault();event.stopPropagation();this.setState({selected:index,isMoreDropdownOpen:false,isSettingsDropdownOpen:false});if(this.props.onTabChange){this.props.onTabChange(this.props.children[index].key,index)}},handleClickSettings:function handleClickSettings(e){this.setState({isMoreDropdownOpen:false,isSettingsDropdownOpen:!this.state.isSettingsDropdownOpen})},handleClickMore:function handleClickMore(i,props){this.setState({isMoreDropdownOpen:!this.state.isMoreDropdownOpen,isSettingsDropdownOpen:false})},handleMoreVisibility:function handleMoreVisibility(value){this.state.isMoreDropdownOpen=value},handleSettingsVisibility:function handleSettingsVisibility(value){this.state.isSettingsDropdownOpen=value},handleTitle:function handleTitle(i,props){},_renderSettings:function _renderSettings(){var settingsVisibility=this.props.getSettings?"":"hidden";return React.createElement("li",{className:"settings dropdown",title:"Settings",style:{visibility:settingsVisibility}},React.createElement("button",{type:"button",className:"button",onClick:this.handleClickSettings},React.createElement("i",{className:"fa fa-cog fa-lg"})),React.createElement(Dropdown,{isOpen:this.state.isSettingsDropdownOpen,onVisibilityChanged:this.handleSettingsVisibility,key:"signIn"},this.props.getSettings?this.props.getSettings(this.props):null))},_renderTitles:function _renderTitles(){function labels(child,index){var tabClass="item"+(this.state.selected===index?" active":"");return child.props?React.createElement("li",{key:index,title:"",className:tabClass,onClick:this.handleClick.bind(this,index)},child.props.label):null}return React.createElement("ul",{className:this.props.name+"-menu"},this._renderSettings(),React.createElement("li",{className:"more dropdown"},React.createElement("span",{className:"",onClick:this.handleClickMore},"More",React.createElement("i",{className:"fa fa-angle-down"})),React.createElement(Dropdown,{isOpen:this.state.isMoreDropdownOpen,onVisibilityChanged:this.handleMoreVisibility,key:"signIn"},this.state.more?this.state.more:null)),React.createElement("ul",{className:"list",onClick:this.handleTitle},this.props.children.map(labels.bind(this))))},_renderContent:function _renderContent(){if(!this.props.tabsOnly){var TabPanel=null;if(this.props.children&&this.state.selected!=undefined&&this.state.selected>=0&&this.state.selected<this.props.children.length&&this.props.children[this.state.selected]){var TabPanel=this.props.children[this.state.selected];if(TabPanel!=null){if(TabPanel.type==null){return React.createElement("div",{className:this.props.name+"-content"},React.createElement(TabPanel,TabPanel.props))}else{return React.createElement("div",{className:this.props.name+"-content"},TabPanel)}}}}},render:function render(){return React.createElement("div",{className:this.props.name},this._renderTitles(),this._renderContent())}});exports.Tabs=Tabs;var TypeSelector=React.createClass({displayName:"TypeSelector",getInitialState:function getInitialState(){return{showSelector:false,type:this.props.type,targetEntity:"",browseMode:true}},componentWillMount:function componentWillMount(){var self=this},componentWillReceiveProps:function componentWillReceiveProps(nextProps){if(nextProps.visible){this.browse(nextProps.type)}},handlePageNavigation:function handlePageNavigation(parent){this.browse(parent)},browse:function browse(type){var entities=type.execute("listSubTypes");this.setState({type:type,entities:entities,browseMode:true,targetEntity:""})},formatName:function formatName(entity,emphasize){if(entity){var name=entity.execute("getName");if(name){if(emphasize){return React.createElement("strong",null,name)}else{return name}}else{return React.createElement("i",null,"< ",entity.id," > ")}}},handleSelectType:function handleSelectType(type){var shouldClose=true;if(this.props.onSelect){if(type){shouldClose=this.props.onSelect(type)}else{shouldClose=this.props.onSelect(this.state.targetEntity,this.state.type)}}if(shouldClose){this.handleClose()}else{var targetEntity="";this.setState({targetEntity:targetEntity})}},selectType:function selectType(type){if(this.state.browseMode){this.handleSelectType(this.state.type)}else{this.handleSelectType(type)}},handleClose:function handleClose(){if(this.props.onClose){this.props.onClose()}var targetEntity="";this.setState({targetEntity:targetEntity})},selectTerm:function selectTerm(targetEntity){var results=void 0;if(targetEntity){var newFinder=window.builtInBlocks.types.newFinder;newFinder.execute("setFilter",{term:targetEntity});newFinder.execute("clearFacets");var entities=this.state.type.execute("listAllSubTypes",newFinder);results={count:entities.size,entities:entities}}this.setState({targetEntity:targetEntity,results:results,browseMode:false})},handleTargetEntitySelect:function handleTargetEntitySelect(type){var targetEntity=type.execute("getName")||type.id;this.selectTerm(targetEntity)},handleTargetEntityChange:function handleTargetEntityChange(e){var targetEntity=e.target.value;this.selectTerm(targetEntity)},buildRow:function buildRow(value,itself){var name=this.formatName(value);var instances=value.execute("listAllSubTypes");var newEntity=void 0;var instanceCount=void 0;if(instances&&instances.size){var instanceCountLabel=instances.size;instanceCountLabel+=instances.size>1?" instances":" instance";instanceCount=React.createElement("span",{className:"icon-base number e-type",title:instanceCountLabel},instances.size)}var namePlaceholder=React.createElement("span",{className:"aLink",onClick:this.browse.bind(this,value)},name);if(itself){namePlaceholder=name}var type=React.createElement("li",{className:"row size",key:value.id},React.createElement("div",{className:"main width2"},namePlaceholder),React.createElement("div",{className:"details"},React.createElement("span",{className:"counters"},instanceCount)));return type},render:function render(){var _this=this;if(this.props.visible){var _ret=function(){var type=_this.buildRow(_this.state.type,true);var subTypes=[];if(_this.state.entities){_this.state.entities.forEach(function(value,key){var row=_this.buildRow(value,false);subTypes.push(row)})}var results=[];var resultsCount=0;var searchButton="Search";var browseMode=_this.state.browseMode;var matchedEntity=void 0;if(_this.state.results){resultsCount=_this.state.results.count;searchButton="Create "+_this.state.targetEntity;_this.state.results.entities.forEach(function(value,key){var resultTypeLabel=_this.formatName(value);var resultTypeName=value.execute("getName");var resultTypeName2=resultTypeName?resultTypeName.toUpperCase():null;var targetEntity=_this.state.targetEntity.trim().toUpperCase();if(targetEntity==resultTypeName2||targetEntity==value.id.toUpperCase()){matchedEntity=value;results.push(React.createElement("div",{key:value.id},React.createElement("strong",null,resultTypeLabel)));searchButton=React.createElement("span",null,"Select ",resultTypeLabel," ")}else{results.push(React.createElement("div",{key:value.id},React.createElement("span",{className:"aLink",onClick:_this.handleTargetEntitySelect.bind(_this,value)},resultTypeLabel)))}})}else{browseMode=true}var root=window.builtInBlocks.root;var typeName=_this.props.type&&_this.props.type.id!=root.id?_this.formatName(_this.props.type,true):"entity";var selectionName=_this.formatName(_this.state.type,true);searchButton=browseMode?React.createElement("span",null,"Select ",selectionName):searchButton;return{v:React.createElement(ModalDialog,{onClose:_this.handleClose},React.createElement("div",{className:"modal-content-title"},"Provide the ",typeName," you want to add"),React.createElement("div",{className:"modal-content-container"},React.createElement("div",{className:"entitySearchForm"},React.createElement("input",{type:"text",autoFocus:true,className:"entitySearchName",placeholder:"Entity name",value:_this.state.targetEntity,onChange:_this.handleTargetEntityChange}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn",onClick:_this.selectType.bind(_this,matchedEntity)},searchButton))),React.createElement("div",{className:"breadcrumbs"},React.createElement("div",{className:"title"},"Path: "),React.createElement("div",{className:"content"},React.createElement(EntityPath,{data:_this.state.type,base:_this.props.type,type:"parents",onClick:_this.handlePageNavigation}))),browseMode?React.createElement("div",{className:"browse-types"},React.createElement("div",{className:"row-list"},React.createElement("div",{className:"head strong"},type),React.createElement("ul",{className:"rows pos modal-content-height"},subTypes))):React.createElement("div",{className:"search-types"},React.createElement("div",{className:"row-list"},React.createElement("div",{className:"head strong"},React.createElement("li",{className:"row size"},React.createElement("div",{className:"main width2"},selectionName," type containing '",_this.state.targetEntity,"'"),React.createElement("div",{className:"details"},React.createElement("span",{className:"counters"},React.createElement("span",{className:"icon-base number e-type"},resultsCount))))),React.createElement("ul",{className:"rows pos modal-content-height"},results),React.createElement("button",{className:"btn",onClick:_this.browse.bind(_this,_this.state.type)},"Back to ",selectionName)))))}}();if((typeof _ret==="undefined"?"undefined":_typeof(_ret))==="object")return _ret.v}else{return null}}});exports.TypeSelector=TypeSelector;var util={loadJsComponent:function loadJsComponent(componentUrl,key,onSuccess,onFail){var js=document.createElement("script");js.type="text/javascript";js.src=componentUrl;js.onload=function(){if(onSuccess)onSuccess(exports.default,key)};try{document.body.appendChild(js)}catch(e){if(onFail)onFail(e)}}};exports.util=util;
